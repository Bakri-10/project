---
- name: IT Risk Metrics Email Notification
  hosts: localhost
  vars:
    # The survey_appcode value is provided by the controller survey
    survey_appcode: "{{ survey_appcode_param | default('ATU0')}}"
    # Environment from the template values
    vault_env: "{{ vault_environment | default('DEV')}}"
    # HashiCorp Vault secrets path definitions
    secrets:
    - namespace: vault_credentials
      app_code: "{{ survey_appcode | upper }}"
      vault_env: "{{ vault_environment }}"
      vault_secret_path: "AAP/server_compliance_reporting/credentials"
    - namespace: vault_extravars
      app_code: "{{ survey_appcode | upper }}"
      vault_env: "{{ vault_environment }}"
      vault_secret_path: "AAP/server_compliance_reporting/extra_vars"

  roles:
    # HashiCorp Vault initialization role
    # Uncomment to use with actual vault
    # - role: rbc_common.hashicorp_vault.vault_init
    #   vars:
    #     survey_appcode: "{{ survey_appcode | default('ATU0')}}"
    #     vault_environment: "{{ vault_environment | default('DEV')}}"
    #     vault_environment:
    #       # Choose environment
    #       # - DEV
    #       # - QAT
    #       # - PROD

  tasks:
  - name: Assign secrets to dedicated variables
    ansible.builtin.set_fact:
      # These values would normally come from HashiCorp Vault
      # es_service_id: "{{ vault[vault_environment].vault_credentials.es_service_id }}"
      # es_service_id_password: "{{ vault[vault_environment].vault_credentials.es_service_id_password }}"
      es_service_id: "SATU0SRVECEWRITE"
      es_service_id_password: "R4@.iE@GmdVMp3"
    no_log: true

  - name: Assign extra vars to dedicated variables
    ansible.builtin.set_fact:
      # These values would normally come from HashiCorp Vault or the template 
      # to: "{{ vault[vault_environment].vault_extravars.to }}"
      # es_url: "{{ vault[vault_environment].vault_extravars.es_url }}"
      # server_compliance_metrics_index: "{{ vault[vault_environment].vault_extravars.server_compliance_metrics_index }}"
      to: "feyi.sodipo@rbc.com"
      es_url: "https://e87a6cd02ed34b0b844d64cc7d8c41a9.ece.saifg.rbc.com:9243"
      server_compliance_metrics_index: "atu0-server-compliance-metrics"

  - name: Installing elastic module
    ansible.builtin.pip:
      name: elasticsearch
      # name: elasticsearch==8.17.2 if it fails
      state: present

  - name: Fetch data from Elasticsearch
    ansible.builtin.include_tasks: roles/tasks/fetch_data.yml
    vars:
      app_codes: "ATU0"
      raw_data_file: "roles/files/output/vulnerability_report_raw.json"

  - name: Process data and generate reports
    ansible.builtin.include_tasks: roles/tasks/process_data.yml
    vars:
      raw_data_file: "roles/files/output/vulnerability_report_raw.json"
      output_dir: "roles/files/output"
      role_path: "roles"

  - name: Loop through app codes and notify app custodian
    vars:
      vault_path: "AAP/server_compliance_reporting/extra_vars"
      raw_data_file: "roles/files/output/vulnerability_report_raw.json"
      output_dir: "roles/files/output"
      role_path: "roles"
    ansible.builtin.include_tasks: roles/tasks/notify_custodian.yml
